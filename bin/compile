#!/usr/bin/env bash
# bin/compile <build-dir> <cache-dir>

set -e
set -o pipefail

BUILD_DIR=$1
CACHE_DIR=$2

function indent() {
  c='s/^/       /'
  case $(uname) in
    Darwin) sed -l "$c";;
    *)      sed -u "$c";;
  esac
}

cd $BUILD_DIR/nginx

# configure
if [ -f configure ]; then
  echo "-----> Configuring Nginx"
  ./configure --prefix=/app/nginx --without-http_rewrite_module --with-http_ssl_module 2>&1 | indent
fi

# make
echo "-----> Compiling nginx"
make 2>&1 | indent

echo "-----> Installing nginx"
make install 2>&1 | indent

cd $BUILD_DIR/php

# configure
if [ -f configure ]; then
  echo "-----> Configuring Nginx"
  ./configure --prefix=/app/php 2>&1 | indent
fi

# make
echo "-----> Compiling nginx"
make 2>&1 | indent

echo "-----> Installing nginx"
make install 2>&1 | indent

cd $BUILD_DIR

cat >>boot.sh <<EOF
erb nginx/conf/nginx.conf.erb > nginx/conf/nginx.conf
touch nginx/logs/access.log nginx/logs/error.log
(tail -f -n 0 nginx/logs/*.log &)
mkdir client_body_temp
mkdir fastcgi_temp
mkdir proxy_temp
mkdir scgi_temp
mkdir uwsgi_temp
nginx/objs/nginx -p ./nginx
EOF

chmod +x boot.sh
